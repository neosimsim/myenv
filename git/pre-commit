#!/bin/sh

set -e

if git st --short | grep -q '^.[^[:blank:]]'
then
cat <<EOF
You have unstaged files. This might corrupt the git-hook outcome. Either stage
them or run
git stash push -ku
git commit
git stash pop
EOF
exit 1
fi

set -v

# firefox addons from nur require --allow-import-from-derivation
nix --allow-import-from-derivation flake check
nixpkgs-fmt --check $(find . -name '*.nix' | grep -vE '(cabal|hconv)\.nix')
nix shell .#noX.pkgs.emacs-git-with-packages --command emacs --batch --eval "(package-activate-all)" -l nix/home/emacs/init.el
nix shell .#withPlasma.pkgs.emacs-git-with-packages --command emacs --batch --eval "(package-activate-all)" -l nix/home/emacs/init.el
